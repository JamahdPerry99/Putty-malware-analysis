# Putty-malware-analysis

Silly Putty Analysis

 

This is the analysis for SillyPutty inside of Matt Husky’s Practical Malware Analysis & Triage course. Goal of this challenge is to put some static and dynamic analysis tools and techniques to use and answer some questions about this malware

 

# Static Analysis:

# Q1: What is the SHA256 hash of the sample?

  To answer this we have to simply find the hash of the malware. In the terminal we can type”sha256sum [file name]” to get the SHA256 hash. We can also use md5sum [file       name]” to get the md5 hash as well. We can also use Pestudio to get the hash (I will show this later on in the example).
 
  ![Alt Text](https://github.com/JamahdPerry99/Putty-malware-analysis/blob/022e97627f3147dd127e365fec9acc51d2cca62c/Hash.png)


# Q2: What architecture is this binary?

   For this, lets use a tool called pestudio(that I mentioned in Q1). This tool is used to help spead up the process of malware analysis, see the screenshot below, you         will also see the hashes of the files.
      ![Alt Text](https://github.com/JamahdPerry99/Putty-malware-analysis/blob/f0f1be13e3dfd838f495fc141211a8cd25f47346/PEStudio.png)

# Q3: Are there any results from submitting the SHA256 hash to VirusTotal?

This is easy we should all be familiar with Virustotal

# Q4: Describe the results of pulling the strings from this binary. Record and describe any strings that are potentially interesting. Can any interesting information be extracted from the strings?

 We can use FLOSS to search for strings or we can use pestudio. This is where we are looking for potential red flags of malware. I am familiar with putty as being a         legitimate program, looking through the strings, I could not find anything and thought this might have been a trick and it was legit. When I went back through husk           walkthrough during this part, he did say that this section was meant to be difficult and throw a curveball at us. Putty has certain API calls and edits to the registry that are part of the program itself.
 ![Alt Text](https://github.com/JamahdPerry99/Putty-malware-analysis/blob/f0f1be13e3dfd838f495fc141211a8cd25f47346/Floss.png)

# Q5: Describe the results of inspecting the IAT for this binary. Are there any important worth noting?

I opened up the binary inside of PEview and looked at the import Address Table. I then used a database for malicious API called (https://malapi.io/). Using this website help me out a lot, I am new to this so, it helps me get familiar with what can be malicious or red flags.
![Alt Text](https://github.com/JamahdPerry99/Putty-malware-analysis/blob/f0f1be13e3dfd838f495fc141211a8cd25f47346/PEview.png)

# Q6: Is it likely that this binary is packed?
By using PEview and inspecting the virtual Size and the size of raw data and comparing the values, we will be able to see if the binary is packed or unpacked. The calculations and comparison of both of these values is nearly identical, So we can accurately determine thus is unlikely packed.
 ![Alt Text](https://github.com/JamahdPerry99/Putty-malware-analysis/blob/f0f1be13e3dfd838f495fc141211a8cd25f47346/PEview%20to%20see%20binary.png)

# Dynamic Analysis

 

# Q1: Describe initial detonation. Are there any notable occurrences at first detonation? Without internet simulation? With internet simulation?

Now this is the best part in my opinion. We are going to do two detonations of this malware. The first without INetSim running on our ReMnux machine, and the second while INetSim IS running.
So the first time I ran the executable as administrator, there was a PowerShell screen that opened up in the background, which closed after about 3 seconds(I use putty at my work, so I knew that was not suppose to happen). There was also a folder created on my Desktop titled “PS Transcripts” with a text file inside. Inside this text document it has logs of PowerShell commands.
![Alt Text](https://github.com/JamahdPerry99/Putty-malware-analysis/blob/f0f1be13e3dfd838f495fc141211a8cd25f47346/detonation%20w_o%20internet.png)
After resetting the VM and having INetSim and Wireshark started on my REMnux machine, I executed the potential malware again. The same powershell screen opened up and quickly closed after a couple of secnds, and the log folder was put onto the desktop. I then went over the REMnux machine and took a look at the wireshark capture, and one of the things I noticed was that my machine was maybe reaching out to a “Window Update” page in reference to disallowed certificates. Also, the user agent for this request was “Microsoft-CryptoAPI”.
![Alt Text](https://github.com/JamahdPerry99/Putty-malware-analysis/blob/f0f1be13e3dfd838f495fc141211a8cd25f47346/detonation%20with%20internet.png)

# Q2: From the host-based indicators perspective, what is the main payload that is initiated at detonation? What tool can you use to identify this?

I know I jumped ahead of myself a little bit(Probably because this is very exciting to me). Now looking at host-based indicators, we can open up procmon and see what processes are created upon execution of this program.  We will want to filter by the “Process Name” which is “Putty.exe. Once we do that we can find the PPID(parent Process ID) that is given. Now we will just use the PPID to help us answer this question.
![Alt Text](https://github.com/JamahdPerry99/Putty-malware-analysis/blob/f0f1be13e3dfd838f495fc141211a8cd25f47346/ProcMon.png)
![Alt Text](https://github.com/JamahdPerry99/Putty-malware-analysis/blob/a2c5333b7ac989bffa521ff575b3a1cc63b39f61/2nd%20procmon.png)

# Q3: What is the DNS record that is queried at detonation?

Back to our REMnux machine and Wireshark, we can see the attempted traffic on our network. One of these queries is unlike the other.
![Alt Text](https://github.com/JamahdPerry99/Putty-malware-analysis/blob/f0f1be13e3dfd838f495fc141211a8cd25f47346/Wireshark%20for%20DNS.png)

# Q4: What is the callback port number at detonation?

Utilizing Wireshark we can determine which port is being utilized as a callback. We can see the three-way handshake starting and being sent to TCP port 8443. Matt’s walkthrough also talks about using TCPView to find this information. (TCPView is a great tool, but I have been wanting to use Wireshark to help me get better).
![Alt Text](https://github.com/JamahdPerry99/Putty-malware-analysis/blob/f0f1be13e3dfd838f495fc141211a8cd25f47346/Port%20callback.png)

# Q5: What is the callback protocol at the detonation?

This was probably the hardest part in my opinion of this lab. I have never done this before. So far we have found that this PowerShell process seems to be reaching out to a remote port 8443 to this “bonus2…local” domain. After watching Matt’s video I realized this a some sort of reverse shell. I was a little stumped at properly identifying the callback protocol, however I wanted to assum it was HTTPS due to when I was using Wireshark capture sending a lot of traffic on port 443. To verify this I followed Matt’s guide to find the following information out.
First thing to do is edit the hosts file and set our loopback as the “bonus2..local” this will trick the reverse shell into having a domain to connect back to. Now we are going to establish netcat on port 8443. Netcat will listen to see what connects port 8443 makes. We have to be sure we have Wireshark up and running also.
![Alt Text](https://github.com/JamahdPerry99/Putty-malware-analysis/blob/f0f1be13e3dfd838f495fc141211a8cd25f47346/callback%20protocal.png)
![Alt Text](https://github.com/JamahdPerry99/Putty-malware-analysis/blob/f0f1be13e3dfd838f495fc141211a8cd25f47346/ncat.png)
After doing this we can see in the wireshark output that we have a TLS/Client Hello.
![Alt Text](https://github.com/JamahdPerry99/Putty-malware-analysis/blob/f0f1be13e3dfd838f495fc141211a8cd25f47346/results.png)

# Q6: How can you use host-based telemetry to identify the DNS record, port, and protocol?

We utilized our tools such as wireshark and procmon to view the actual powershell script.

# Q7: Attempt to get the binary to initiate a shell on the localhost. Does a shell spawn? What is needed for a shell to spawn?

The information gathered (and watching Matts walkthrough videos to get a better understanding) a connection is not established. Due to TLS handshake not being able to finish the handshake any connection is terminated when trying to run any commands.
 

# My personal opinion on this lab:


I think I did pretty good on this lab overall. Some of the things I spent a lot of time are trying to find interesting strings and looking at PEview at the IAT(Import address table). The dynamic analysis, was kind of difficult at certain points, one of the things that got me was the PowerShell script was a one-liner encoded base64, I didn’t go into much detail about it, but after looking at the walk through, is hould have. Another part I had difficult with was the trick to edit our host file in order to attempt a connection for a shell. This was very unique because I have never done anything like this before, but now I know how to do it. This challenge was quite fun and it was a great for my first time actually doing malware analysis on my own. I can’t wait to do my next challenge. 
